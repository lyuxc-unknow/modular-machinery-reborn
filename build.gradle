plugins {
  id 'java-library'
  id 'eclipse'
  id 'idea'
  id 'maven-publish'
  id 'net.neoforged.gradle.userdev' version '7.0.142'
  id "me.shedaniel.unified-publishing" version "0.1.+"
  id "io.freefair.lombok" version "8.6"
}

tasks.named('wrapper', Wrapper).configure {
  distributionType = Wrapper.DistributionType.BIN
}

repositories {
  mavenLocal()
}

base {
  archivesName = archives_base_name
  version = "${minecraft_version}-${mod_version}"
}

java.toolchain.languageVersion = JavaLanguageVersion.of(21)
java.withSourcesJar()

File transformer = rootProject.file("src/main/resources/META-INF/accesstransformer.cfg")

if (transformer.exists()) {
  minecraft.accessTransformers.file transformer
}

runs {
  configureEach {
    systemProperty 'forge.logging.markers', 'REGISTRIES'
    systemProperty 'forge.logging.console.level', 'debug'

    modSource project.sourceSets.main
  }

  client {
    systemProperty 'forge.enabledGameTestNamespaces', project.mod_id
  }

  server {
    systemProperty 'forge.enabledGameTestNamespaces', project.mod_id
    programArgument '--nogui'
  }

  gameTestServer {
    systemProperty 'forge.enabledGameTestNamespaces', project.mod_id
  }

  data {
    programArguments.addAll '--mod', project.mod_id, '--all', '--output', file('src/generated/resources/').getAbsolutePath(), '--existing', file('src/main/resources/').getAbsolutePath()
  }
}

// Include resources generated by data generators.
sourceSets.main.resources { srcDir 'src/generated/resources' }

configurations {
  runtimeClasspath.extendsFrom localRuntime
}

repositories {
  maven {
    name = "Jared's maven"
    url = "https://maven.blamejared.com/"
    content {
      includeGroup "mezz.jei"
    }
  }
  maven {
    name = "Shedaniel's maven"
    url = "https://maven.shedaniel.me/"
    content {
      includeGroup "me.shedaniel.cloth"
    }
  }
  maven {
    name = "Lat's maven"
    url = "https://maven.saps.dev/releases"
    content {
      includeGroup "dev.latvian.mods"
    }
  }
  maven {
    url = "https://maven.architectury.dev"
    content {
      includeGroup "dev.architectury"
    }
  }
  maven {
    name = "Mod maven"
    url = "https://modmaven.dev/"
    content {
      includeGroup "mcjty.theoneprobe"
      includeGroup "mekanism"
    }
  }
  maven {
    url "https://www.cursemaven.com"
    content {
      includeGroup "curse.maven"
    }
  }
  maven {
    name = "Covers"
    // for rf stuffs
    url = "https://maven.covers1624.net"
  }
}

dependencies {
  // lombok
  compileOnly "org.projectlombok:lombok:${project.lombok_version}"
  annotationProcessor "org.projectlombok:lombok:${project.lombok_version}"
  implementation "net.neoforged:neoforge:${neo_version}"

  // Cloth config
  api("me.shedaniel.cloth:cloth-config-neoforge:${cloth_config_version}")

  // ProbeJS
  localRuntime("curse.maven:probejs-585406:5536459")

  // JEI
  compileOnly("mezz.jei:jei-${minecraft_version}-neoforge-api:${jei_version}")
  localRuntime("mezz.jei:jei-${minecraft_version}-neoforge:${jei_version}")

  // KubeJS
//  compileOnly("dev.latvian.mods:kubejs-neoforge:${kubejs_version}")
  implementation("dev.latvian.mods:kubejs-neoforge:${kubejs_version}")

  // Jade
  localRuntime compileOnly("curse.maven:jade-324717:${jade_version}")

  // Mekanism
  localRuntime("mekanism:Mekanism:${mekanism_version}")
}

tasks.withType(ProcessResources).configureEach {
  var replaceProperties = [
      minecraft_version      : minecraft_version,
      minecraft_version_range: minecraft_version_range,
      neo_version            : neo_version,
      neo_version_range      : neo_version_range,
      loader_version_range   : loader_version_range,
      mod_id                 : mod_id,
      mod_name               : mod_name,
      mod_license            : mod_license,
      mod_version            : mod_version,
      mod_authors            : mod_authors,
      mod_description        : mod_description,
      mod_url                : mod_url,
      icon                   : icon,
      pack_format_number     : pack_format_number
  ]
  inputs.properties replaceProperties

  filesMatching(['META-INF/neoforge.mods.toml', 'META-INF/mods.toml', 'pack.mcmeta']) {
    expand replaceProperties + [project: project]
  }
}

// Example configuration to allow publishing using the maven-publish plugin
publishing {
  publications {
    register('mavenJava', MavenPublication) {
      groupId = maven_group
      artifactId = archivesBaseName
      version = project.version
      from components.java

      pom {
        name = mod_name
        description = mod_description
        packaging = 'jar'
        scm {
          url = mod_github
        }
        issueManagement {
          system = 'github'
          url = mod_issues
        }
        licenses {
          license {
            name = mod_license
            distribution = 'repo'
          }
        }
        developers {
          developer {
            id = mod_authors
            name = mod_authors
            roles = ['developper']
          }
        }
      }
    }
  }
  repositories {
    maven {
      name = 'maven'
      url = 'D:\\local_maven'
    }
  }
}

tasks.withType(JavaCompile).configureEach {
  options.encoding = 'UTF-8' // Use the UTF-8 charset for Java compilation
}

// IDEA no longer automatically downloads sources/javadoc jars for dependencies, so we need to explicitly enable the behavior.
idea {
  module {
    downloadSources = true
    downloadJavadoc = true
  }
}

unifiedPublishing {
  project {
    displayName = "[NeoForge]ModularMachineyReborn-${minecraft_version}-${mod_version}"
    releaseType = "beta"
    if(rootProject.file("CHANGELOG.md").exists()) {
      changelog = rootProject.file("CHANGELOG.md").text
    }
    gameVersions = ["${minecraft_version}"]
    gameLoaders = ["neoforge"]
    mainPublication jar

//        var CURSE_API_KEY = System.getenv("CURSEFORGE")
//        if (CURSE_API_KEY != null) {
//            curseforge {
//                token = CURSE_API_KEY
//                id = "457017"
//                gameVersions.addAll "Java 21"
//                relations {
//                    depends "cloth-config"
//                    optional "kubejs"
//                    optional "crafttweaker"
//                    optional "jei"
//                    optional "the-one-probe"
//                    optional "jade"
//                }
//            }
//        }

//        var MODRINTH_TOKEN = System.getenv("MODRINTH")
//        if (MODRINTH_TOKEN != null) {
//            modrinth {
//                token = MODRINTH_TOKEN
//                id = "OrB5XFtI"
//                relations {
//                    depends "cloth-config"
//                    optional "kubejs"
//                    optional "crafttweaker"
//                    optional "jei"
//                    optional "the-one-probe"
//                    optional "jade"
//                }
//            }
//        }
  }
}
